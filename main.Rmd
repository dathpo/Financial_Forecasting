---
title: "Financial Forecasting"
output:
  html_document
---
```{r}
library(neuralnet)
library(quantmod)
library(caret)
library(ggplot2)
library(scales)

assets <- c("BTC-USD")
assets <- sort(assets)
stocks = lapply(assets, function(sym) {
  dailyReturn(na.omit(getSymbols(sym,
                                   src="yahoo",
                                   from="2015-02-20",
                                   to="2019-02-20",
                                   auto.assign=FALSE)))
})

df <- as.data.frame(do.call(merge.xts, stocks))
names(df) <- assets
df
```
```{r}
df <- data.frame(df,
                 x1=Lag(df, 1))
names(df) <- c('x1', 'y')
nrow(df)
head(df)
```

```{r}
df <- na.omit(df)
nrow(df)
head(df)
```
```{r}
train.index <- round(0.8 * nrow(df))
train.df <- df[1:train.index,]
test.df <- df[-(1:train.index),]
tail(train.df)
head(test.df)
nrow(train.df)
nrow(test.df)
```
```{r, fig.width=11, fig.height=4}
plot.train.df <- cbind(day = rownames(train.df), train.df)
plot.test.df <- cbind(day = rownames(test.df), test.df)
ggplot() +
geom_line(data=plot.train.df, aes(x=as.Date(plot.train.df$day), y=plot.train.df$y, colour="Training")) +
geom_line(data=plot.test.df, aes(x=as.Date(plot.test.df$day), y=plot.test.df$y, colour="Test")) +
xlab("Date") + ylab("Return") + scale_y_continuous(labels=percent)
ggsave("btcperf.pdf", width=8, height=4)
```
```{r}
x.test <- test.df[, 1:(length(names(df))-1)]
y.test <- test.df[, length(names(df))]
y.train <- train.df[, length(names(df))]
set.seed(42)
net <- neuralnet(y~x1,
                 train.df,
                 hidden = c(90, 60, 30, 20),
                 threshold = 0.03
                 # stepmax = 1e+9
                 # rep = 5
)
y.train.pred <- as.data.frame(net$net.result)
colnames(y.train.pred) <- c("V1")
net$result.matrix[1:3,]
```
```{r}
y.train.comp.df <- cbind(y.train, y.train.pred, plot.train.df$day)
colnames(y.train.comp.df) <- c("y (train)", "y pred. (train)", "Date")

pred <- neuralnet::compute(net, x.test)
y.test.pred <- as.data.frame(pred$net.result)
y.test.comp.df <- cbind(y.test, y.test.pred, plot.test.df$day)
colnames(y.test.comp.df) <- c("y (test)", "y pred. (test)", "Date")

cat("RMSE on Training Set:\n")
train.rmse <- RMSE(pred = y.train.pred$V1, obs = y.train)
train.rmse

cat("\nRMSE on Test Set:\n")
test.rmse <- RMSE(pred = y.test.pred$V1, obs = y.test)
test.rmse

cat("\nRMSE Difference (Test - Train):\n")
test.rmse - train.rmse
```
```{r}
# plot(net)
```